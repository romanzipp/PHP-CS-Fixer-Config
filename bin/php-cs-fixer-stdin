#!/usr/bin/env php
<?php

// Inspired from https://gist.github.com/vuon9/be16429f751e12f72e220c18777d9bc7

function is_fixer_command(string $a): bool
{
    return in_array($a, [
        'check',
        'describe',
        'fix',
        'help',
        'list',
        'list-files',
        'list-sets',
        'self-update',
    ]);
}

function error_exit(string $message): void
{
    fwrite(STDERR, $message . PHP_EOL);
    exit(1);
}

$tmpFile = tempnam(sys_get_temp_dir(), 'fix_');
$isDebug = false;

array_shift($argv);

$files = [];
$commandFound = false;
$commandAndArguments = [];

foreach ($argv as $k => $param) {
    if ('' == $param) {
        continue;
    }

    if ('--debug' == $param) {
        $isDebug = true;
        continue;
    }

    if (is_fixer_command($param)) {
        if ( ! $commandFound) {
            $commandFound = true;
        }

        $commandAndArguments[] = $param;
        continue;
    }

    if ('-' == substr($param, 0, 1)) {
        $commandAndArguments[] = $param;
        continue;
    }

    $files[] = $param;
}

if ( ! $commandFound) {
    error_exit('No php-cs-fixer command provided');
}

if (0 === count($files)) {
    error_exit('No files provided');
}

if (count($files) > 1) {
    error_exit('Only one file allowed');
}

$filePath = $files[0];
if ($isDebug) {
    echo 'Absolute file path: ' . $filePath . PHP_EOL;
}

@file_put_contents($tmpFile, file_get_contents($filePath));

$checkFixerBinaryResult = exec('which php-cs-fixer');
if ('' === $checkFixerBinaryResult) {
    error_exit('php-cs-fixer binary not found in $PATH folders');
}

$output = [];
$returnCode = 0;
$arguments = implode(' ', $commandAndArguments);
if ($isDebug) {
    echo 'Command and arguments: ' . $arguments . PHP_EOL;
}

$cmd = sprintf('php-cs-fixer %s %s', $arguments, $tmpFile);
if ($isDebug) {
    echo 'Forwarded command: ' . $cmd . PHP_EOL;
}

// Actually run the command
exec($cmd, $output, $returnCode);

if ($returnCode) {
    exit($returnCode);
}

echo file_get_contents($tmpFile);
unlink($tmpFile);
